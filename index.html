<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Core2 Dashboard</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; }
    .row { display: flex; gap: 20px; flex-wrap: wrap; }
    .card { border: 1px solid #ccc; border-radius: 10px; padding: 12px; min-width: 280px; }
    label { display:block; margin-top:8px; }
    input[type=text], input[type=number] { width: 100%; padding:6px; }
    button { padding: 8px 12px; margin-top: 8px; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body>
  <h1>M5Stack Core2 Dashboard</h1>

  <div class="row">
    <div class="card">
      <h3>接続設定</h3>
      <label>WebSocket URL（例: <code>wss://broker.hivemq.com:8884/mqtt</code>）</label>
      <input id="wsUrl" type="text" value="wss://broker.hivemq.com:8884/mqtt" />
      <label>デバイスID</label>
      <input id="deviceId" type="text" placeholder="core2-xxxxxxxx" />
      <button id="btnConnect">接続</button>
      <div id="status">未接続</div>
    </div>

    <div class="card">
      <h3>受信（テレメトリ）</h3>
      <div>Subscribe Topic: <code id="subTopic">-</code></div>
      <pre id="telemetry" style="height:160px; overflow:auto;"></pre>
    </div>

    <div class="card">
      <h3>送信（コマンド）</h3>
      <div>Publish Topic: <code id="pubTopic">-</code></div>
      <label>アクション</label>
      <input id="action" type="text" value="beep" />
      <label>freq</label>
      <input id="freq" type="number" value="1500" />
      <label>ms</label>
      <input id="ms" type="number" value="200" />
      <button id="btnSend">送信</button>
    </div>
  </div>

  <!-- Paho MQTT JS（公式CDN） -->
  <script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>
  <script>
    let client = null;
    let subTopic = "";
    let pubTopic = "";

    function logTelemetry(line) {
      const pre = document.getElementById('telemetry');
      pre.textContent = (line + "\n" + pre.textContent).slice(0, 8000);
    }

    document.getElementById('btnConnect').onclick = () => {
      const wsUrl   = document.getElementById('wsUrl').value.trim();
      const deviceId= document.getElementById('deviceId').value.trim();
      if (!wsUrl || !deviceId) { alert("WS URLとDevice IDを入れてね"); return; }

      subTopic = `lab/core2/${deviceId}/telemetry`;
      pubTopic = `lab/core2/${deviceId}/cmd`;
      document.getElementById('subTopic').textContent = subTopic;
      document.getElementById('pubTopic').textContent = pubTopic;

      // 一意なクライアントID
      const cid = "web-" + Math.random().toString(16).slice(2);
      client = new Paho.MQTT.Client(wsUrl, cid);

      client.onConnectionLost = (res) => {
        document.getElementById('status').textContent = "切断: " + res.errorMessage;
      };
      client.onMessageArrived = (msg) => {
        if (msg.destinationName === subTopic) {
          logTelemetry(msg.payloadString);
        }
      };

      client.connect({
        useSSL: wsUrl.startsWith("wss://"),
        timeout: 5,
        onSuccess: () => {
          document.getElementById('status').textContent = "接続OK";
          client.subscribe(subTopic);
        },
        onFailure: (err) => {
          document.getElementById('status').textContent = "接続失敗: " + err.errorMessage;
        }
      });
    };

    document.getElementById('btnSend').onclick = () => {
      if (!client || !client.isConnected()) { alert("未接続です"); return; }
      const action = document.getElementById('action').value.trim();
      const freq   = Number(document.getElementById('freq').value);
      const ms     = Number(document.getElementById('ms').value);
      const payload = JSON.stringify({ action, freq, ms, ts: Date.now() });
      const msg = new Paho.MQTT.Message(payload);
      msg.destinationName = pubTopic;
      client.send(msg);
    };
  </script>
</body>
</html>
