<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>みとくけん・簡易ダッシュボード</title>
  <style>
    body{margin:0;background:#0f172a;color:#e2e8f0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:900px;margin:32px auto;padding:0 16px}
    h1{font-weight:700;margin:0 0 12px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:16px;margin:12px 0}
    .ok{color:#22c55e} .ng{color:#ef4444} .warn{color:#f59e0b}
    pre{white-space:pre-wrap;word-break:break-word;background:#0b1020;border:1px solid #1f2937;border-radius:8px;padding:12px}
    button{background:#2563eb;color:#fff;border:0;border-radius:8px;padding:10px 16px;font-weight:600;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
  </style>
  <!-- MQTT over WebSocket ライブラリ -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>みとくけん ダッシュボード（最小テスト）</h1>

    <div class="card">
      <div>WebSocket 接続先：<code id="url">wss://mqtt.eclipseprojects.io:443/mqtt</code></div>
      <div>トピック：<code id="topic">mitokuken/alert</code></div>
      <div id="state" class="warn" style="margin-top:8px">接続中…</div>
      <div style="margin-top:12px">
        <button id="beep" disabled>テスト音を鳴らす</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:6px">受信ログ</div>
      <pre id="log">(まだありません)</pre>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:6px">エラー/詳細</div>
      <pre id="err">(なし)</pre>
    </div>
  </div>

  <script>
    // ===== 設定 =====
    const BROKER_URL = "wss://mqtt.eclipseprojects.io:443/mqtt";
    const TOPIC      = "mitokuken/alert";

    // ===== 画面ユーティリティ =====
    const $state = document.getElementById("state");
    const $log   = document.getElementById("log");
    const $err   = document.getElementById("err");
    const $beep  = document.getElementById("beep");
    const beep = () => {
      try {
        const a = new (window.AudioContext || window.webkitAudioContext)();
        const o = a.createOscillator();
        const g = a.createGain();
        o.type = "sine"; o.frequency.value = 880;
        o.connect(g); g.connect(a.destination);
        g.gain.setValueAtTime(0.0001, a.currentTime);
        g.gain.exponentialRampToValueAtTime(0.4, a.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, a.currentTime + 0.25);
        o.start(); o.stop(a.currentTime + 0.27);
      } catch (e) { /* 音失敗は無視 */ }
    };
    $beep.onclick = beep;

    function setState(text, cls){ $state.textContent = text; $state.className = cls || ""; }
    function pushLog(s){
      $log.textContent = ($log.textContent==="(まだありません)"?"":$log.textContent+"\n") + s;
    }
    function pushErr(e){
      const msg = (e && e.message) ? e.message : String(e);
      $err.textContent = ($err.textContent==="(なし)"?"":$err.textContent+"\n") + msg;
    }

    // ===== MQTT 接続 =====
    let client;
    try {
      client = mqtt.connect(BROKER_URL, {
        clientId: "mitokuken-web-" + Math.random().toString(16).slice(2),
        keepalive: 60,
        clean: true,
        reconnectPeriod: 2000,
        connectTimeout: 8000,
      });
    } catch (e) {
      setState("接続初期化エラー", "ng"); pushErr(e); throw e;
    }

    client.on("connect", () => {
      setState("接続済み", "ok");
      $beep.disabled = false;
      client.subscribe(TOPIC, { qos: 0 }, (err) => {
        if (err) { pushErr("subscribe 失敗: " + err.message); setState("購読失敗", "ng"); }
      });
    });

    client.on("reconnect", () => setState("再接続中…", "warn"));
    client.on("close",     () => setState("切断", "ng"));
    client.on("error",     (e) => { setState("エラー", "ng"); pushErr(e); });

    client.on("message", (_topic, payload) => {
      let text;
      try {
        text = new TextDecoder().decode(payload);
        const obj = JSON.parse(text);
        pushLog(`[${new Date().toLocaleTimeString()}] ${text}`);
        // 受信したら音を1回
        beep();
      } catch (e) {
        pushErr("JSONパース失敗: " + e.message + " / raw=" + text);
      }
    });

    // 参考：手動送信（コンソールから）
    window._pub = (obj={type:"alert",accel:1.5,ts:Date.now(),src:"TEST"})=>{
      client.publish(TOPIC, JSON.stringify(obj));
    };
  </script>
</body>
</html>
