<script>
  // ★ WebSocket のブローカURL（/mqtt を忘れない）
  const BROKER_URL = "wss://test.mosquitto.org:8081/mqtt";
  const TOPIC      = "mitokuken/alert";

  const client = mqtt.connect(BROKER_URL, {
    clientId: "mitokuken-web-" + Math.random().toString(16).slice(2),
    keepalive: 60,
    clean: true,
    reconnectPeriod: 2000,    // 再接続 2s
    connectTimeout: 8000,     // タイムアウト 8s
  });

  client.on("connect", () => {
    setStatus("接続済み");
    client.subscribe(TOPIC, { qos: 0 });
  });

  client.on("reconnect", () => setStatus("再接続中…"));
  client.on("close",     () => setStatus("切断"));
  client.on("error",     (err) => setStatus("エラー: " + err.message));

  client.on("message", (topic, payload) => {
    const msg = new TextDecoder().decode(payload);
    // ここでアラート表示／音を鳴らす
    onAlert(JSON.parse(msg));
  });

  function setStatus(t){ document.querySelector("#conn").textContent = t; }
</script>
