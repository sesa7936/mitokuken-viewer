<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>M5Core2 MQTT Dashboard</title>

  <!-- ✅ Paho MQTT 読み込み（絶対必要） -->
  <script src="https://unpkg.com/paho-mqtt/paho-mqtt.min.js"></script>

  <style>
    body{background:#0f172a;color:#e2e8f0;font-family:system-ui;padding:20px;}
    input,button{padding:10px;margin:5px;border-radius:8px;border:1px solid #334155;background:#1e293b;color:white;}
    .log{height:300px;overflow:auto;background:#0b1220;padding:10px;border-radius:8px;}
  </style>
</head>
<body>

<h2>M5Core2 ↔ Web（HiveMQ WSS）</h2>

<div>
  Device ID:
  <input id="devId" value="segawa-core2-01">
  <button onclick="connectMQTT()">Connect</button>
  <span id="status">Disconnected</span>
</div>

<div class="log" id="log"></div>

<script>
let client=null;
let baseTopic="";

function log(t){
  let area=document.getElementById("log");
  area.innerText = t + "\n" + area.innerText;
}

function connectMQTT(){
  const dev=document.getElementById("devId").value.trim();
  baseTopic = "m5core2/"+dev;

  client = new Paho.Client(
    "broker.hivemq.com",
    8884,
    "/mqtt",
    "webclient-"+Math.random().toString(16).slice(2)
  );

  client.onConnectionLost = ()=> log("Connection Lost");
  client.onMessageArrived = (msg)=> log(msg.destinationName+" → "+msg.payloadString);

  client.connect({
    useSSL:true,
    timeout:8,
    onSuccess: ()=>{
      document.getElementById("status").innerText="Connected";
      log("Connected");

      client.subscribe(baseTopic+"/events");
      client.subscribe(baseTopic+"/telemetry");
      log("Subscribed: "+baseTopic+"/events, "+baseTopic+"/telemetry");
    },
    onFailure:(e)=>{
      document.getElementById("status").innerText="Failed";
      log("Connect failed: "+JSON.stringify(e));
    }
  });
}
</script>

</body>
</html>
