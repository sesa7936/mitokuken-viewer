<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>みとくけんダッシュボード（Web=B機）</title>
<style>
  :root {
    --ok:#11a36a;
    --warn:#ff3b30;
    --bg:#0f1115;
    --fg:#e6e9ee;
    --muted:#8b90a0;
    --card:#171a21;
    --accent:#3b82f6;
  }
  html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif; }
  .wrap { max-width:880px; margin:0 auto; padding:20px; }
  h1 { font-size:22px; margin:8px 0 16px; font-weight:700; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
  .card { background:var(--card); border-radius:14px; padding:16px; box-shadow: 0 6px 20px rgba(0,0,0,.25); }
  .label { font-size:12px; color:var(--muted); letter-spacing:.02em; }
  .value { font-size:28px; font-weight:800; margin-top:6px; }
  .ok { color:var(--ok); }
  .bad { color:var(--warn); }
  .btnrow { display:flex; gap:12px; flex-wrap:wrap; margin-top:14px; }
  button { appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer; color:#fff; background:var(--accent); }
  button.secondary { background:#2d3444; color:#cfd5e2; }
  .status { margin-top:16px; font-size:13px; color:var(--muted); line-height:1.6; }
  .banner { margin:16px 0; padding:14px; border-radius:12px; background:#1c2230; display:flex; align-items:center; gap:12px; }
  .dot { width:10px; height:10px; border-radius:999px; background:var(--ok); box-shadow:0 0 0 0 rgba(17,163,106,.8); }
  .blink { animation: blink 1s linear infinite; }
  @keyframes blink { 50% { opacity:.25 } }
  .alarm { background:var(--warn); box-shadow:0 0 16px var(--warn); }
  a { color:#9fc1ff; text-decoration: none; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
</style>
</head>
<body>
<div class="wrap">
  <h1>みとくけん ダッシュボード（Web = B機）</h1>

  <div class="banner">
    <div id="connDot" class="dot"></div>
    <div>
      <div class="label">接続状態</div>
      <div id="connText" class="value ok">未接続</div>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <div class="label">A機（送信元）</div>
      <div id="aState" class="value">待機</div>
      <div class="status">
        最終受信: <span id="aTime" class="mono">—</span><br/>
        受信加速度: <span id="aAccel" class="mono">—</span> g
      </div>
      <div class="btnrow">
        <button id="startBtn">監視開始（音を有効化 & 接続）</button>
        <button id="muteBtn" class="secondary">音をミュート</button>
        <button id="resetBtn" class="secondary">解除（コマンド送信）</button>
      </div>
    </div>

    <div class="card">
      <div class="label">アラーム</div>
      <div id="alarmState" class="value ok">停止中</div>
      <div class="status">
        トピック: <span class="mono">mitokuken/alert</span><br/>
        ブローカー: <span class="mono">wss://test.mosquitto.org:8081</span>
      </div>
    </div>
  </div>

  <div class="status">
    ※ 初回は「監視開始」を押してから衝撃を与えてください（ブラウザの自動再生制限のため音が鳴る許可が必要）<br/>
    ※ 公開ブローカー利用のため、他者のメッセージが混ざる可能性があります。実運用は認証付きMQTT推奨です。
  </div>
</div>

<!-- MQTT.js (WebSocket) -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  // ---- 設定 ----
  const BROKER_URL = "wss://test.mosquitto.org:8081";
  const TOPIC_RX   = "mitokuken/alert"; // A機→Web
  const TOPIC_TX   = "mitokuken/cmd";   // Web→A機（解除など）
  const CLIENT_ID  = "mitokuken_web_" + Math.random().toString(16).slice(2);

  // ---- 要素参照 ----
  const connDot   = document.getElementById('connDot');
  const connText  = document.getElementById('connText');
  const aStateEl  = document.getElementById('aState');
  const aTimeEl   = document.getElementById('aTime');
  const aAccelEl  = document.getElementById('aAccel');
  const alarmEl   = document.getElementById('alarmState');
  const startBtn  = document.getElementById('startBtn');
  const muteBtn   = document.getElementById('muteBtn');
  const resetBtn  = document.getElementById('resetBtn');

  // ---- サウンド準備（ユーザー操作で解放）----
  let audioCtx, osc, gain;
  let muted = false;
  function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    gain = audioCtx.createGain();
    gain.gain.value = 0;
    gain.connect(audioCtx.destination);
    osc = audioCtx.createOscillator();
    osc.type = 'square';
    osc.frequency.value = 880;   // アラーム音
    osc.connect(gain);
    osc.start();
  }
  function alarmOn()  { if (!muted && gain) { gain.gain.setTargetAtTime(0.15, audioCtx.currentTime, 0.01); } }
  function alarmOff() { if (gain)          { gain.gain.setTargetAtTime(0.0,  audioCtx.currentTime, 0.02); } }

  muteBtn.onclick = () => {
    muted = !muted;
    muteBtn.textContent = muted ? "音をミュート解除" : "音をミュート";
    if (muted) alarmOff();
  };

  // ---- MQTT 接続（監視開始で実行）----
  let client = null;
  startBtn.onclick = async () => {
    initAudio();
    try { await audioCtx.resume(); } catch(e){}
    connectMQTT();
  };

  function connectMQTT() {
    if (client && client.connected) return;
    connText.textContent = "接続中…";
    connText.classList.remove('ok'); connText.classList.remove('bad');
    connDot.classList.add('blink'); connDot.classList.remove('alarm');

    client = mqtt.connect(BROKER_URL, {
      clientId: CLIENT_ID,
      clean: true,
      reconnectPeriod: 2000,
    });

    client.on('connect', () => {
      connText.textContent = "接続OK";
      connText.classList.add('ok');
      connDot.classList.remove('blink'); connDot.style.background = "var(--ok)";
      client.subscribe(TOPIC_RX);
    });

    client.on('reconnect', () => {
      connText.textContent = "再接続中…";
      connText.classList.remove('ok'); connText.classList.remove('bad');
      connDot.classList.add('blink');
    });

    client.on('close', () => {
      connText.textContent = "未接続";
      connText.classList.remove('ok'); connText.classList.add('bad');
      connDot.classList.add('blink'); connDot.style.background = "var(--warn)";
      alarmOff();
      alarmEl.textContent = "停止中";
      alarmEl.classList.remove('bad'); alarmEl.classList.add('ok');
      aStateEl.textContent = "待機";
    });

    client.on('message', (topic, payload) => {
      if (topic !== TOPIC_RX) return;
      let msg = null;
      try { msg = JSON.parse(payload.toString()); } catch(e){ return; }

      const now = new Date();
      aTimeEl.textContent  = now.toLocaleTimeString();
      aAccelEl.textContent = (msg.accel ?? 0).toFixed(2);

      if (msg.type === "alert") {
        // アラーム発火
        aStateEl.textContent = "警報受信";
        aStateEl.classList.add('bad');
        alarmEl.textContent = "鳴動中";
        alarmEl.classList.remove('ok'); alarmEl.classList.add('bad');
        document.body.classList.add('blink');
        connDot.classList.add('alarm');
        alarmOn();
      } else if (msg.type === "reset") {
        clearAlarmUI();
      }
    });

    resetBtn.onclick = () => {
      if (!client || !client.connected) return;
      client.publish(TOPIC_TX, JSON.stringify({ type:"reset", ts: Date.now(), src:"web" }));
      clearAlarmUI();
    };
  }

  function clearAlarmUI() {
    alarmOff();
    alarmEl.textContent = "停止中";
    alarmEl.classList.remove('bad'); alarmEl.classList.add('ok');
    aStateEl.textContent = "待機";
    aStateEl.classList.remove('bad');
    document.body.classList.remove('blink');
    connDot.classList.remove('alarm');
  }
</script>
</body>
</html>