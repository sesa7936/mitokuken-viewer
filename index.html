<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã¿ã¨ãã‘ã‚“ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>

<!-- MQTT.js (browser) -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
  :root { --ok:#0aa84f; --warn:#c62828; --bg:#0b0e12; --card:#12161c; --text:#e8eef6; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;}
  header{padding:16px 20px;border-bottom:1px solid #1e2630;}
  main{max-width:900px;margin:0 auto;padding:24px 16px;display:grid;gap:16px;}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:var(--card);border:1px solid #1e2630;border-radius:14px;padding:18px;}
  .title{font-weight:700;font-size:18px;margin:0 0 6px}
  .muted{opacity:.7;font-size:13px;margin:0 0 8px}
  .status{display:flex;align-items:center;gap:8px;margin-top:8px}
  .dot{width:12px;height:12px;border-radius:999px;background:#999}
  .dot.ok{background:var(--ok)}
  .dot.bad{background:var(--warn);animation:blink 0.8s infinite}
  @keyframes blink{50%{opacity:.4}}
  #bigAlert{position:fixed;inset:0;pointer-events:none;opacity:0;background:rgba(198,40,40,.20);transition:opacity .12s}
  #bigAlert.show{opacity:1}
  button{background:#1f2937;color:#e8eef6;border:1px solid #324055;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  button:hover{filter:brightness(1.15)}
  code{background:#0f141a;padding:2px 6px;border-radius:6px}
  .log{font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap}
</style>

<header>
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
    <h1 style="font-size:20px;margin:0">ã¿ã¨ãã‘ã‚“ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btnNotify">ğŸ”” é€šçŸ¥ON</button>
      <button id="btnTest">ãƒ‡ãƒ¢è­¦å ±</button>
    </div>
  </div>
  <div class="muted">MQTT: <code>wss://test.mosquitto.org:8081/mqtt</code> / Topic: <code>mitokuken/alert</code>, <code>mitokuken/ack</code></div>
</header>

<main>
  <div class="row">
    <section class="card">
      <h2 class="title">å—ä¿¡çŠ¶æ…‹</h2>
      <div class="muted">A æ©Ÿï¼ˆè¡æ’ƒæ¤œçŸ¥ï¼‰ / B æ©Ÿï¼ˆè§£é™¤ï¼‰</div>
      <div class="status"><span class="dot" id="dotConn"></span><span id="txtConn">æ¥ç¶šä¸­â€¦</span></div>
      <div class="status"><span class="dot" id="dotA"></span><span id="txtA">A: å¾…æ©Ÿ</span></div>
      <div class="status"><span class="dot" id="dotB"></span><span id="txtB">B: å¾…æ©Ÿ</span></div>
    </section>
    <section class="card">
      <h2 class="title">æœ€æ–°ã‚¤ãƒ™ãƒ³ãƒˆ</h2>
      <div id="lastEvent" class="muted">â€”</div>
      <audio id="beep" preload="auto">
        <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBHQAA" type="audio/wav">
      </audio>
    </section>
  </div>
  <section class="card">
    <h2 class="title">ãƒ­ã‚°</h2>
    <div id="log" class="log"></div>
  </section>
</main>

<div id="bigAlert"></div>

<script>
/** ========= è¨­å®š ========= **/
const MQTT_URL   = "wss://test.mosquitto.org:8081/mqtt";   // TLS WebSocket
const TOPIC_ALERT= "mitokuken/alert";  // A æ©Ÿ â†’ è¡æ’ƒ
const TOPIC_ACK  = "mitokuken/ack";    // B æ©Ÿ â†’ è§£é™¤ï¼ˆâ€»å¾Œè¿°ã®Bãƒ‘ãƒƒãƒï¼‰

/** ========= UI å‚ç…§ ========= **/
const dotConn = document.getElementById('dotConn');
const dotA    = document.getElementById('dotA');
const dotB    = document.getElementById('dotB');
const txtConn = document.getElementById('txtConn');
const txtA    = document.getElementById('txtA');
const txtB    = document.getElementById('txtB');
const lastEvent = document.getElementById('lastEvent');
const logEl   = document.getElementById('log');
const bigAlert= document.getElementById('bigAlert');
const beepEl  = document.getElementById('beep');

function log(s){ const t=`[${new Date().toLocaleTimeString()}] ${s}\n`; logEl.textContent = t + logEl.textContent.slice(0, 6000); }

function setDot(el, ok){ el.classList.remove('ok','bad'); el.classList.add(ok?'ok':'bad'); }

function flashAlert(ms=1200){
  bigAlert.classList.add('show');
  setTimeout(()=>bigAlert.classList.remove('show'), ms);
}

async function notify(title, body){
  try{
    if(Notification.permission==='granted'){
      new Notification(title,{body});
    }
  }catch(e){}
}

document.getElementById('btnNotify').onclick = async ()=>{
  if(Notification.permission!=='granted') await Notification.requestPermission();
  alert('é€šçŸ¥ã‚’è¨±å¯ã—ã¾ã—ãŸï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã„ã¤ã§ã‚‚å¤‰æ›´ã§ãã¾ã™ï¼‰ã€‚');
};

document.getElementById('btnTest').onclick = ()=>{
  onAlert({src:'DEMO', accel:1.88, ts:Date.now()});
};

/** ========= MQTT æ¥ç¶š ========= **/
const clientId = "dash_" + Math.random().toString(16).slice(2);
const client = mqtt.connect(MQTT_URL, { clientId, clean:true, reconnectPeriod: 1500 });

client.on('connect', ()=>{
  setDot(dotConn,true); txtConn.textContent = "æ¥ç¶š OK";
  client.subscribe([TOPIC_ALERT, TOPIC_ACK], { qos:0 }, (err)=> {
    if(err){ log("subscribe error: "+err); }
    else { log("Subscribed: " + TOPIC_ALERT + ", " + TOPIC_ACK); }
  });
});

client.on('reconnect', ()=>{ setDot(dotConn,false); txtConn.textContent = "å†æ¥ç¶šä¸­â€¦"; });
client.on('close', ()=>{ setDot(dotConn,false); txtConn.textContent = "åˆ‡æ–­"; });
client.on('error', (e)=> log("MQTT error: "+e.message));

client.on('message', (topic, payload)=>{
  let s = payload.toString();
  log(`RX ${topic}: ${s}`);

  try{
    const j = JSON.parse(s);
    if (topic === TOPIC_ALERT) onAlert(j);
    if (topic === TOPIC_ACK)   onAck(j);
  }catch{
    // JSONã§ãªã„å ´åˆã¯ç°¡æ˜“æ‰±ã„
    if (topic === TOPIC_ALERT) onAlert({src:'A?', accel:NaN, ts:Date.now(), raw:s});
    if (topic === TOPIC_ACK)   onAck({src:'B?', ts:Date.now(), raw:s});
  }
});

function onAlert(ev){
  setDot(dotA,false); txtA.textContent = `A: è¡æ’ƒï¼ g=${ev.accel??'?'}`;
  lastEvent.textContent = `A è¡æ’ƒ g=${ev.accel??'?'}  @ ${new Date(ev.ts||Date.now()).toLocaleString()}`;
  flashAlert();
  try{ beepEl.currentTime=0; beepEl.play(); }catch(e){}
  notify("âš  è¡æ’ƒã‚’æ¤œçŸ¥", `g=${ev.accel ?? '?'}`);
}

function onAck(ev){
  setDot(dotB,true); txtB.textContent = "B: è§£é™¤";
  lastEvent.textContent = `B è§£é™¤ @ ${new Date(ev.ts||Date.now()).toLocaleString()}`;
}
</script>
</html>
